# Codex 使用统计（Analytics v1）闭环测试计划

## 准备

- 确保本机已有 `~/.codex/sessions/**/rollout-*.jsonl`
- 确保至少有 1 个 skill 存在于 `~/.codex/skills/**`（含 `.system/*`）
- 已知某次会话中会触发 `superpowers-codex use-skill <skill_key>`
  - 若日志为 `superpowers:<name>`，当 `~/.codex/skills/<name>` 存在时会按 `<name>` 计数

## 用例 1：默认关闭不读取日志

1. 启动 Skills Hub
2. 确认 Analytics → Codex 使用统计开关为关闭
3. 观察：不应触发扫描（无“上次扫描时间”变化；后台无读取报错）

## 用例 2：启用后不回溯历史

1. 开启 Codex 使用统计
2. 立即查看排行榜：应为空或接近空（不包含启用前的历史事件）

## 用例 2b：历史回填（手动导入）

1. 开启 Codex 使用统计
2. 在“历史回填”区域点击“加载日期”，选中一个或多个日期（支持全选）
3. 点击“回填选中日期”
4. 预期：扫描结果里 `matched/skipped/dups` 有变化；榜单在切换到 7d 或 all 后出现数据

## 用例 3：启用后新增事件可计数

1. 在 Codex 里触发一次 `use-skill <skill_key>`（确保该 skill 存在于 `~/.codex/skills/**`，并且会话日志会写入对应 function_call）
2. 等待一个扫描周期或点“立即扫描”
3. 预期：排行榜该 skill 的调用次数 +1；最近一次使用时间更新

## 用例 4：增量扫描不重复计数

1. 连续点两次“立即扫描”（或等待两次周期）
2. 预期：在没有新日志的情况下，调用次数不应继续增加

## 用例 5：项目归一化（默认 git root）

1. 在同一个 git 仓库下的不同子目录触发两次同一 skill 的 `use-skill`
2. 预期：项目数应为 1（详情页显示为同一 `project_path`），调用次数为 2

## 用例 6：保留期清理（30 天）

1. 将保留期设为 1 天（便于测试）
2. 制造一条“旧事件”（可通过修改 DB/注入测试数据）
3. 等待清理任务触发或手动触发清理逻辑
4. 预期：旧事件被删除，榜单聚合随之变化

## 用例 7：清空统计数据

1. 点击“清空统计”
2. 预期：榜单清空；游标被重置为 EOF（后续扫描不会把旧日志重新计入）
